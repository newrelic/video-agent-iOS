name: Publish to CocoaPods

on:
  pull_request:
    types:
      - closed
    branches:
      - master

  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: macos-latest
    # Only run if PR was merged and has release label
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'release'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.merge_commit_sha || github.sha }}

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false

      - name: Install CocoaPods
        run: |
          gem install cocoapods
          pod --version

      - name: Extract version from podspec
        id: get_version
        run: |
          VERSION=$(grep "s.version" NewRelicVideoAgent.podspec | sed -E "s/.*s\.version[[:space:]]*=[[:space:]]*'([0-9]+\.[0-9]+\.[0-9]+)'.*/\1/")
          echo "Extracted version from podspec: $VERSION"
      
          if [ -z "$VERSION" ]; then
            echo "Failed to extract version"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION"

      - name: Cleanup existing tag if present
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"

          # Check if tag exists locally
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Tag v$VERSION exists locally, deleting..."
            git tag -d "v$VERSION"
          fi

          # Check if tag exists on remote
          if git ls-remote --tags origin | grep -q "refs/tags/v$VERSION"; then
            echo "Tag v$VERSION exists on remote, deleting..."
            git push --delete origin "v$VERSION" || echo "Failed to delete remote tag (may not have permission)"
          else
            echo "Tag v$VERSION does not exist on remote"
          fi

      - name: Validate podspecs
        run: |
          echo "Validating podspecs..."

          validate_with_retry() {
            local podspec=$1
            local max_attempts=3
            local attempt=1

            while [ $attempt -le $max_attempts ]; do
              echo "Validating $podspec (attempt $attempt/$max_attempts)..."

              set +e
              pod lib lint $podspec --allow-warnings 2>&1 | tee validation_output.log
              EXIT_CODE=$?
              set -e

              if [ $EXIT_CODE -eq 0 ]; then
                echo "$podspec validated successfully"
                rm -f validation_output.log
                return 0
              else
                if grep -qi "internal server error" validation_output.log || grep -qi "connection.*timed out" validation_output.log; then
                  echo "Transient error detected for $podspec"
                  if [ $attempt -lt $max_attempts ]; then
                    echo "Retrying in 10 seconds..."
                    sleep 10
                    attempt=$((attempt + 1))
                  else
                    echo "Failed after $max_attempts attempts"
                    cat validation_output.log
                    rm -f validation_output.log
                    return 1
                  fi
                else
                  echo "Validation failed with non-retryable error"
                  cat validation_output.log
                  rm -f validation_output.log
                  return 1
                fi
              fi
            done
          }

          # Validate each podspec with retry logic
          validate_with_retry "NewRelicVideoAgent.podspec"
          validate_with_retry "NRAVPlayerTracker.podspec"
          validate_with_retry "NRIMATracker.podspec"

          echo ""
          echo "All podspecs validated successfully!"



      - name: Setup CocoaPods trunk authentication
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: |
          if [ -z "$COCOAPODS_TRUNK_TOKEN" ]; then
            echo "Error: COCOAPODS_TRUNK_TOKEN secret is not set"
            echo "Please add your CocoaPods trunk token to GitHub repository secrets"
            exit 1
          fi

          cat > ~/.netrc <<EOF
          machine trunk.cocoapods.org
          login token
          password ${COCOAPODS_TRUNK_TOKEN}
          EOF
          chmod 600 ~/.netrc

          echo "CocoaPods trunk authentication configured"

      - name: Create and push git tag
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Creating tag v$VERSION..."
          git tag "v$VERSION"
          git push origin "v$VERSION"
          echo "Tag v$VERSION created and pushed successfully!"

      - name: Publish NewRelicVideoAgent
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"

          # Check if version is already published
          if pod trunk info NewRelicVideoAgent | grep -q "- $VERSION"; then
            echo "NewRelicVideoAgent $VERSION is already published, skipping..."
          else
            echo "Publishing NewRelicVideoAgent $VERSION..."

            set +e
            pod trunk push NewRelicVideoAgent.podspec --allow-warnings 2>&1 | tee publish_output.log
            EXIT_CODE=$?
            set -e

            if [ $EXIT_CODE -eq 0 ]; then
              echo "NewRelicVideoAgent published successfully!"
            else
              if grep -q "Unable to accept duplicate entry" publish_output.log; then
                echo "Duplicate entry error - pod was already published"
              elif grep -qi "internal server error" publish_output.log; then
                echo "Internal server error occurred. Verifying if pod was actually published..."
                sleep 5
                if pod trunk info NewRelicVideoAgent | grep -q "- $VERSION"; then
                  echo "Pod was published successfully despite server error!"
                else
                  echo "Pod was NOT published due to server error. Please retry the workflow."
                  cat publish_output.log
                  exit 1
                fi
              else
                echo "Unexpected error during publishing:"
                cat publish_output.log
                exit 1
              fi
            fi
            rm -f publish_output.log
          fi

      - name: Wait for NewRelicVideoAgent indexing
        run: |
          echo "Waiting for NewRelicVideoAgent to be indexed by CocoaPods..."
          echo "This usually takes ~5 minutes..."

          VERSION="${{ steps.get_version.outputs.version }}"
          MAX_ATTEMPTS=20
          ATTEMPT=0
          WAIT_TIME=30

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Checking if NewRelicVideoAgent $VERSION is indexed..."

            if pod search NewRelicVideoAgent | grep -q "$VERSION"; then
              echo "NewRelicVideoAgent $VERSION is now indexed!"
              exit 0
            fi

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "Not indexed yet, waiting ${WAIT_TIME} seconds..."
              sleep $WAIT_TIME
            fi
          done

          echo "Timeout waiting for indexing, proceeding anyway..."

      - name: Publish NRAVPlayerTracker
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"

          # Check if version is already published
          if pod trunk info NRAVPlayerTracker | grep -q "- $VERSION"; then
            echo "NRAVPlayerTracker $VERSION is already published, skipping..."
          else
            echo "Publishing NRAVPlayerTracker $VERSION..."

            set +e
            pod trunk push NRAVPlayerTracker.podspec --allow-warnings 2>&1 | tee publish_output.log
            EXIT_CODE=$?
            set -e

            if [ $EXIT_CODE -eq 0 ]; then
              echo "NRAVPlayerTracker published successfully!"
            else
              if grep -q "Unable to accept duplicate entry" publish_output.log; then
                echo "Duplicate entry error - pod was already published"
              elif grep -qi "internal server error" publish_output.log; then
                echo "Internal server error occurred. Verifying if pod was actually published..."
                sleep 5
                if pod trunk info NRAVPlayerTracker | grep -q "- $VERSION"; then
                  echo "Pod was published successfully despite server error!"
                else
                  echo "Pod was NOT published due to server error. Please retry the workflow."
                  cat publish_output.log
                  exit 1
                fi
              else
                echo "Unexpected error during publishing:"
                cat publish_output.log
                exit 1
              fi
            fi
            rm -f publish_output.log
          fi

      - name: Publish NRIMATracker
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"

          if pod trunk info NRIMATracker | grep -q "- $VERSION"; then
            echo "NRIMATracker $VERSION is already published, skipping..."
          else
            echo "Publishing NRIMATracker $VERSION..."

            set +e
            pod trunk push NRIMATracker.podspec --allow-warnings 2>&1 | tee publish_output.log
            EXIT_CODE=$?
            set -e

            if [ $EXIT_CODE -eq 0 ]; then
              echo "NRIMATracker published successfully!"
            else
              if grep -q "Unable to accept duplicate entry" publish_output.log; then
                echo "Duplicate entry error - pod was already published"
              elif grep -qi "internal server error" publish_output.log; then
                echo "Internal server error occurred. Verifying if pod was actually published..."
                sleep 5
                if pod trunk info NRIMATracker | grep -q "- $VERSION"; then
                  echo "Pod was published successfully despite server error!"
                else
                  echo "Pod was NOT published due to server error. Please retry the workflow."
                  cat publish_output.log
                  exit 1
                fi
              else
                echo "Unexpected error during publishing:"
                cat publish_output.log
                exit 1
              fi
            fi
            rm -f publish_output.log
          fi

      - name: Extract changelog excerpt
        id: changelog
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          VERSION_REGEX=$(echo "$VERSION" | sed 's/\./\\./g')
          start=$(grep -n "^## \[$VERSION_REGEX\]" CHANGELOG.md | cut -d: -f1)

          if [ -z "$start" ]; then
            CHANGELOG="See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md) for details."
          else
            end=$(awk -v start="$start" 'NR > start && /^## \[/ {print NR; exit}' CHANGELOG.md)
            if [ -z "$end" ]; then
              tail -n +"$((start+1))" CHANGELOG.md > excerpt.txt
            else
              sed -n "$((start+1)),$((end-1))p" CHANGELOG.md > excerpt.txt
            fi
            CHANGELOG=$(cat excerpt.txt)
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build XCFrameworks
        run: |
          chmod +x ./build-xcframeworks.sh
          ./build-xcframeworks.sh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          target_commitish: ${{ github.sha }}
          name: Release v${{ steps.get_version.outputs.version }}
          body: |
            ## Release v${{ steps.get_version.outputs.version }}

            Published to CocoaPods:
            - NewRelicVideoAgent `${{ steps.get_version.outputs.version }}`
            - NRAVPlayerTracker `${{ steps.get_version.outputs.version }}`
            - NRIMATracker `${{ steps.get_version.outputs.version }}`

            ### What's Changed

            ${{ steps.changelog.outputs.changelog }}
          files: xcframeworks.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify publication
        run: |
          echo "Verifying publication..."
          VERSION="${{ steps.get_version.outputs.version }}"

          echo ""
          echo "=== NewRelicVideoAgent ==="
          if pod trunk info NewRelicVideoAgent | grep -q "- $VERSION"; then
            echo "NewRelicVideoAgent $VERSION is published"
            pod trunk info NewRelicVideoAgent | grep -A 2 "Versions:" | head -10
          else
            echo "NewRelicVideoAgent $VERSION NOT found"
            exit 1
          fi

          echo ""
          echo "=== NRAVPlayerTracker ==="
          if pod trunk info NRAVPlayerTracker | grep -q "- $VERSION"; then
            echo "NRAVPlayerTracker $VERSION is published"
            pod trunk info NRAVPlayerTracker | grep -A 2 "Versions:" | head -10
          else
            echo "NRAVPlayerTracker $VERSION NOT found"
            exit 1
          fi

          echo ""
          echo "=== NRIMATracker ==="
          if pod trunk info NRIMATracker | grep -q "- $VERSION"; then
            echo "NRIMATracker $VERSION is published"
            pod trunk info NRIMATracker | grep -A 2 "Versions:" | head -10
          else
            echo "NRIMATracker $VERSION NOT found"
            exit 1
          fi

          echo ""
          echo "=================================="
          echo "Release Complete!"
          echo "=================================="
          echo ""
          echo "All pods published successfully for version $VERSION"
          echo ""
          echo "Users can now install with:"
          echo "  pod 'NewRelicVideoAgent', '~> $VERSION'"
          echo "  pod 'NRAVPlayerTracker', '~> $VERSION'"
          echo "  pod 'NRIMATracker', '~> $VERSION'"
          echo ""